var enable_history=false;var editor_win=null;var grecaptcha={};close_editor=function(){editor_win.close();};function welcome_note(){if(user.length==0){show_message("About Scribie.com Freelance Transcription Program");}else{show_message("Welcome to Scribie.com Transcription Test");}}function get_test_info(){if(user.length==0){return show_message("Apply for Scribie.com's Freelance Transcription Program");}if($.trim($('#files').attr('data-paypal_id')).length===0){return show_error('Please setup your PayPal Account');}show_message("Fetching data. Please wait. <img src='/assets/img/ajax.gif'>");$.getJSON("manage_ajax?a=gtti",function(resp){if(resp.e===0){enable_history=resp.s.ns>0||resp.s.nt>0;if(resp.s.na>0){tabfuncmap['files']=get_assigned_files;if(hash!="#files"){$("#files").tab('show');}else{get_assigned_files();}}else if(resp.s.nt>=10){tabfuncmap['files']=get_transcriber_history;if(hash!="#files"){$("#files").tab('show');}else{get_transcriber_history();}}else if(resp.s.ts>=2){tabfuncmap['files']=get_transcriber_history;if(hash!="#files"){$("#files").tab('show');}else{get_transcriber_history();}}else if(resp.s.ts==1){tabfuncmap['files']=get_available_files;if(hash=="#files"){get_available_files();}else{welcome_note();}}else{tabfuncmap['files']=get_available_files;if(hash=="#files"){get_available_files();}else{welcome_note();}}}else{show_error(resp.s);}});}function get_available_files(){if(parseInt($.cookie('recha'))==1){$("#recaptcha-v2").show();return show_error(" Please tick the reCAPTCHA verification.");}$("#recaptcha-v2").hide();if(grecaptcha&&grecaptcha.reset){grecaptcha.reset();}$(".record-list ul li:not(:first)","#files").remove();$(".record-list ul li:first","#files").hide();show_message("Processing request. Please wait. <img src='/assets/img/ajax.gif'>");$.getJSON("manage_ajax?a=ltf&gt=1",function(resp){if(resp.e===0){if(resp.s&&resp.s.f&&resp.s.f.length>0){load_available_files(resp.s.to,resp.s.f);}else{show_message("No test files are available currently");$("#nofiles").fadeIn(500);}if(enable_history){$("form[name='history']","#files").show();}else{$("form[name='history']","#files").hide();}}else{show_error(resp.s);}});}function load_available_files(token,files){show_message("Following test files are available");$("#nofiles").hide();$(".record-list ul li:not(:first)","#files").remove();$(".record-list ul li:first","#files").show();var tmpl=$("#available_files_tmpl");for(var i=0;i<files.length;i++){$("li[class='record']",$(tmpl)).attr("id",i).attr('data-rate',files[i].r);$(".filename",$(tmpl)).text("TestFile.mp3");$(".fileno",$(tmpl)).text((i+1));$(".audio-preview",$(tmpl)).attr("data-mp3","/records/"+files[i].fid+"_"+files[i].pn+".mp3?to="+token).attr('data-seconds',files[i].du);if(files[i].p==1){$(".audio-preview",$(tmpl)).removeClass('btn-info').addClass('btn-default');}else{$(".audio-preview",$(tmpl)).addClass('btn-info').removeClass('btn-default');}$(".duration",$(tmpl)).text(sec_to_ts(files[i].du));$(".amount",$(tmpl)).text(files[i].amt);$("form[name='acceptfile']",$(tmpl)).attr("action","a=atf&id="+files[i].id);$(".verbatim",$(tmpl)).hide();$(".difficulty-level",$(tmpl)).text(files[i].dl);$(".accents",$(tmpl)).text(files[i].ac);$(".instructions_block",$(tmpl)).hide();if(files[i].ins){$(".instructions",$(tmpl)).text(files[i].ins).closest('.instructions_block').show();if(files[i].ins.match(/^Strict verbatim/)){$(".verbatim",$(tmpl)).show();}else{$(".verbatim",$(tmpl)).hide();}}$(".record-list ul[id='records']","#files").append($(tmpl).html());}$(".record-list ul li[class='record']","#files").show();$("form[name='acceptfile']","#files").submit(function(e){$("#jquery_jplayer").jPlayer("stop");var preview=$(".audio-preview",$(this).closest("li"));if($(preview).hasClass('btn-info')){$(preview).addClass('animated shake');setTimeout(function(){$(preview).removeClass('animated shake');},1000);e.preventDefault();return show_error("Please click on the blue play button to preview the audio before selecting");}$("input[type='submit']",$(this)).attr("disabled","1");var self=$(this);$.post("manage_ajax",$(this).attr("action")+"&r="+$(this).closest('li').attr('data-rate'),function(resp){if(resp.e===0){show_message("File successfully assigned.");tabfuncmap['files']=get_assigned_files;get_assigned_files();}else if(resp.e===-2){show_error(resp.s);$(self).closest('.record').fadeOut(500,function(){$(this).remove();});}else{show_error(resp.s);}},"json");return false;});}function stop_play(obj){if(obj&&($("img",$(obj)).attr("src")=="/assets/img/stop.png")){$("#jquery_jplayer").jPlayer("stop");$("img",$(obj)).attr("src","/assets/img/play.png");$(obj).removeClass("active");}}function get_assigned_files(){try{show_message("Processing request. Please wait. <img src='/assets/img/ajax.gif'>");$(".record-list ul li:not(:first)","#files").remove();$(".record-list ul li:first","#files").hide();$("form[name='history']","#files").hide();$.getJSON("manage_ajax?a=laf",function(resp){if(resp.e===0){if(resp.s){load_assigned_files(resp.s);}else{show_message("No assigned files founds");}}else{show_error(resp.s);}});}catch(e){var sub="Javascript Exception";var msg="";if((typeof e=="string")||(typeof e=="integer")){msg=e;}else if(typeof e=="object"){msg=e.message?e.message:"Unknown error";}else{msg="Unknown error";}msg+="<br>"+window.navigator.userAgent;$.post("manage_ajax","a=sm&s="+sub+"&m="+encodeURIComponent(msg),function(response){show_error("An error occured. Please reload this page and try again.");},"json");}}var get_assignments=get_assigned_files;function load_assigned_files(files){show_message("Please open the editor to start.");$(".record-list ul li:not(:first)","#files").remove();$(".record-list ul li:first","#files").show();var tmpl=$("#assigned_files_tmpl");for(var i=0;i<files.length;i++){$("li[class='record']",$(tmpl)).attr("id",i);$(".filename",$(tmpl)).text(files[i].fn);$(".duration",$(tmpl)).text(files[i].du);$(".amount",$(tmpl)).text(files[i].amt);$(".filesize",$(tmpl)).text(files[i].sz);$(".transcript",$(tmpl)).show();$(".reassign-msg",$(tmpl)).hide();$("a[href='#editor']",$(tmpl)).attr('data-fno',files[i].fno);$("a[href='#cancel-assignment']",$(tmpl)).attr('data-fno',files[i].fno).attr('data-utf_id',files[i].id);$("#time_left",$(tmpl)).text(sec_to_ts(files[i].ta>0?files[i].ta:0,true));$(".instructions_block",$(tmpl)).hide();if(files[i].ins){$(".instructions",$(tmpl)).text(files[i].ins).closest('.instructions_block').show();}var pnl=$(".accuracy-info",$(tmpl)).addClass('hide');if(files[i].pwer){var acc=Math.round((1-files[i].pwer)*100);$(".accuracy",$(pnl)).text(acc+"%");$(".animated-circle",$(pnl)).attr('data-value',acc)
$(".num-corrections",$(pnl)).text(files[i].nc);$(pnl).removeClass('hide');}$(".ft_block",$(tmpl)).hide();if(files[i].ft){$(".frequent_terms",$(tmpl)).html(files[i].ft).closest('.ft_block').show();}if(files[i].rr&&reassign_reasons_map[files[i].rr]){$(".reassign-reason",$(tmpl)).text(reassign_reasons_map[files[i].rr].long).closest('.reassign-msg').show();}$(".record-list ul[id='records']","#files").append($(tmpl).html());$(".record-list ul li[class='record']","#files").show();$("#time_left","#files").data({'file_no':files[i].fno,type:0});}$(".animated-circle").each(function(){var circle,value;if($(this).hasClass('hide')){return;}if($.trim($(this).text()).length>0){return;}value=$(this).attr('data-value');circle=new ProgressBar.Circle($(this)[0],{trailColor:"#f2f2f2",color:"#5bc0de",strokeWidth:4,trailWidth:4,duration:1000,text:{value:value+"%",style:{color:'#000','font-size':"12px",position:'absolute',left:'50%',top:'50%',padding:0,margin:0,transform:{prefix:true,value:'translate(-50%, -50%)'}}}});return circle.animate(parseInt(value)/100);});set_timeout();}function get_transcriber_history(){$(".record-list ul li:not(:first)","#files").remove();$(".record-list ul li:first","#files").hide();show_message("Processing request. Please wait. <img src='/assets/img/ajax.gif'>");$.getJSON("manage_ajax?a=lth",function(resp){if(resp.e===0){if(resp.s){load_transcriber_history(resp.s);}else{show_message("No files found in history.");}}else{show_error(resp.s);}});}function load_transcriber_history(files){$(".record-list ul li:not(:first)","#files").remove();$(".record-list ul li:first","#files").show();if(files.length>=10){show_message("You have exceeded the maximum number of test attempts.");}var enable_retest=true;$("form[name='retest']",$("#files")).hide();var tmpl=$("#transcriber_history_tmpl");for(var i=0;i<files.length;i++){$("li[class='record']",$(tmpl)).attr("id","history-"+i);$(".id",$(tmpl)).text(i+1);$(".filename",$(tmpl)).text(files[i].fn);$(".duration",$(tmpl)).text(files[i].du);$(".amount",$(tmpl)).text(files[i].amt);$(".difftext",$(tmpl)).attr("id","difftext_"+i);$("a[href='#reassign']",$(tmpl)).hide();$(".further-reviews",$(tmpl)).hide();$(".rating",$(tmpl)).hide();var dt=new Date(parseInt(files[i].ts)*1000);$(".submit_status",$(tmpl)).text(submit_status_map[files[i].ss]+" on "+get_date_time(files[i].ts));if(files[i].ss==2){$(".review_status",$(tmpl)).show().text(review_status_map[files[i].rs]);if(files[i].rs<=1){$(".review_status_check",$(tmpl)).attr("rel","a=crs&id="+files[i].fno).parent().show();$(".diff_check",$(tmpl)).parent().hide();if(i==0){enable_retest=false;show_message("Your submission is pending "+(files[i].rs==0?'screening':'review')+". Please reload this page to update the status.");}}else if(files[i].rs==2){$(".review_status_check",$(tmpl)).parent().hide();$(".diff_check",$(tmpl)).attr("rel","a=gpfd&fno="+files[i].fno).parent().show();$("form[name='diff_types']",$(tmpl)).attr("action","a=gpfd&fno="+files[i].fno);$("form[name='diff_actions']",$(tmpl)).attr("action","a=dpr&id="+files[i].id);if(i==0){enable_retest=false;$.getJSON("manage_ajax?a=crts&id="+files[i].fno,function(resp){if(resp.e===0){if(resp.s==1){if(files.length<10){$(".test-status-msg","#history-0").text("Your submission has been rejected. Please select another test file and submit.").show();show_message("Your submission has been rejected. Please select another test file and submit.");$("form[name='retest']",$("#files")).show();$("#attempts_remaining").text(10-files.length);}else{$(".test-status-msg","#history-0").text("Your submission has been rejected. You may not submit another test file.");show_error("Your submission has been rejected. You may not submit another test file.").show();}}else{var msg="Your submission has been reviewed. However, further reviews are required which will be completed by "+get_short_date(resp.s)+". Please wait until then for the result.";$(".test-status-msg","#history-0").show().text(msg);show_message(msg);}}else{show_error(resp.s);}});}else{$(".review_status",$(tmpl)).text(review_status_map[2]).show();}}else if(files[i].rs==3){$(".review_status_check",$(tmpl)).parent().hide();$(".diff_check",$(tmpl)).parent().hide();if(i==0){enable_retest=true;show_message("Your submission has been rejected");}}$(".review",$(tmpl)).show();}else if(files[i].ss==3){$(".review_status",$(tmpl)).hide();$(".review_status_check",$(tmpl)).parent().hide();$(".diff_check",$(tmpl)).parent().hide();if(i==0){if(files[i].rs==0){$("a[href='#reassign']",$(tmpl)).attr('rel','a=reto&t=0&fno='+files[i].fno+"&id="+files[i].id).show();}enable_retest=true;show_message("Your assignment has timed out");}}else if(files[i].ss==4){$(".review_status",$(tmpl)).hide();$(".review_status_check",$(tmpl)).parent().hide();$(".diff_check",$(tmpl)).parent().hide();if(i==0){enable_retest=true;show_message("Your assignment was cancelled");}}else if(files[i].ss==5){$(".review_status",$(tmpl)).text(review_status_map[3]);$(".review_status_check",$(tmpl)).parent().hide();if(+files[i].rd==1){$(".diff_check",$(tmpl)).attr("rel","a=gpfd&fno="+files[i].fno).parent().show();}else{$(".diff_check",$(tmpl)).parent().hide();}if(i==0){enable_retest=true;show_message("Your submission has been rejected");}}else{$(".review",$(tmpl)).hide();}$(".record-list ul[id='records']","#files").append($(tmpl).html());$(".record-list ul li[class='record']","#files").show();}if(enable_retest){if(files.length<10){$("form[name='retest']",$("#files")).show();$("#attempts_remaining").text(10-files.length);}else{$("form[name='retest']").empty().append($("#max-attempts").html()).show();show_error("The maximum number of allowed attempts has been reached");}}$(".review_status_check","#files").click(function(){var self=this;$.getJSON("manage_ajax?"+$(this).attr("rel"),function(resp){if(resp.e===0){$(self).parent().text(" by "+get_short_date(resp.s));}else{show_error(resp.s);}});return false;});$(".diff_check","#files").click(function(){show_message("Processing request. Please wait. <img src='/assets/img/ajax.gif'>");var self=this;var li=$(this).closest('li.record');$.getJSON("manage_ajax?"+$(this).attr("rel"),function(resp){if(resp.e===0){$(self).parent().text("");var dmp=new diff_match_patch();dmp.Diff_Timeout=10;var d=dmp.diff_main(resp.s.t1,resp.s.t2);dmp.diff_cleanupSemantic(d);$(".difftext",$(li)).html(dmp.diff_prettyHtml(d)).parent().show();show_message("Displaying diff");}else{show_error(resp.s);}});return false;});$("input[name='diff_type']","#files").click(function(){var li=$(this).closest('li.record');var type=$(this).val();var self=this;show_message("Processing. Please wait. <img src='/assets/img/ajax.gif'>");$.getJSON("manage_ajax?"+$("form[name='diff_types']",$(li)).attr("action")+"&t="+type,function(resp){if(resp.e===0){if(type==0){var dmp=new diff_match_patch();dmp.Diff_Timeout=10;var d=dmp.diff_main(resp.s.t,resp.s.r);dmp.diff_cleanupSemantic(d);$(".difftext",$(li)).html(dmp.diff_prettyHtml(d)).parent().show();}else{$(".difftext",$(li)).html(resp.s.replace(/\n/g,"<br />")).parent().show();}show_message("Displaying "+$(self).attr('title').toLowerCase());}else{show_error(resp.s);}});});$('.difftext',"#files").click(function(){if($("input[name='diff_type']:checked",$(this).parent()).val()!=0){SelectText($(this).attr("id"));}});timeout_reassignment_handler($("#files"),function(){tabfuncmap['files']=get_assigned_files;get_assigned_files();$("form[name='retest']","#files").hide();});}function on_timeout(){tabfuncmap['files']=get_transcriber_history;get_transcriber_history();}$(function(){$("#tabs").delegate("form[name='history']","submit",function(e){e.preventDefault();$(this).hide();$("#nofiles").hide();get_transcriber_history();}).delegate("a[href='#editor']",'click',function(e){e.preventDefault();var btn=$(this).addClass('disabled');if(editor_win&&!editor_win.closed){editor_win.focus();$(btn).removeClass('disabled');}else{editor_win=window.open('/file/transcribe/'+$(this).attr('data-fno'),'_blank','titlebar=no,location=no,menubar=no,toolbar=no,status=no,scrollbars=no,resizeable=no,top=0,left=0,height='+window.screen.availHeight+',width='+window.screen.availWidth);editor_win.onload=function(){$(btn).removeClass('disabled');};editor_win.onunload=function(e){get_assignments();}
window.onbeforeunload=function(e){if(editor_win&&!editor_win.closed){return'Please note that the Editor window will be closed';}return;};window.onunload=function(e){if(editor_win&&!editor_win.closed){editor_win.close();}};window.onfocus=function(e){get_test_info();};}}).delegate("a[href='#cancel-assignment']",'click',function(e){e.preventDefault();show_message("Processing. Please wait. <img src='/assets/img/ajax.gif'>");var li=$(this).closest('li');return $.ajax({type:'POST',url:"/manage_ajax",data:{a:"cas",fno:$(this).attr('data-fno'),id:$(this).attr('data-utf_id')},dataType:"json",success:function(res){if(res.e!==0)return show_error(res.s);show_message("Test cancelled successfully");tabfuncmap['files']=get_transcriber_history;get_transcriber_history();}}).fail(function(){return show_error("An error occurred. Please try again after some time.");});});$("#files").on('submit',"form[name='diff_actions']",function(e){e.preventDefault();$("form","#raise-dispute").attr('action',$(this).attr('action'));$("#raise-dispute").modal();}).on('click',"a[href='#diffNotes']",function(e){e.preventDefault();$("#disputes-help").modal();});});